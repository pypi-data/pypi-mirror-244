"use strict";(self["webpackChunk_quetz_frontend_main_app"]=self["webpackChunk_quetz_frontend_main_app"]||[]).push([[7557],{17557:(e,t,a)=>{a.r(t);a.d(t,{CommandIDs:()=>I,default:()=>A});var n=a(34494);var s=a(85168);var l=a(79450);var r=a(98078);var i=a(18303);var o=a(98635);var c=a(28390);var m=a(2411);var h=a(5089);var u=a(30325);var p=a(34878);var d=a.n(p);class _ extends l.ReactWidget{constructor(){super();this._handleDescription=e=>{this._api_key_info.description=e.target.value;this.update()};this._handleExpire=e=>{this._api_key_info.expire_at=e.target.value;this.update()};this._handleUserCheck=e=>{this._user_api_key=e.target.checked;this.update()};this._handleChannel=e=>{this._role.channel=e.target.value;const t=this._channels.find((e=>e.name===this._role.channel));if(t){switch(t.role){case"owner":this._roles=["member","maintainer","owner"];break;case"maintainer":this._roles=["member","maintainer"];break;case"member":this._roles=["member"];break;default:this._roles=[];break}}else{this._roles=[]}this._packages_channel=this._packages.filter((e=>e.channel_name===this._role.channel));this.update()};this._handlePackage=e=>{this._role.package=e.target.value;const t=this._packages.find((e=>e.name===this._role.package));if(t){switch(t.role){case"owner":this._roles=["member","maintainer","owner"];break;case"maintainer":this._roles=["member","maintainer"];break;case"member":this._roles=["member"];break}}this.update()};this._handleRole=e=>{this._role.role=e.target.value;this.update()};this._addRole=()=>{this._api_key_info.roles.push(this._role);this._role={channel:"",package:"",role:"member"};this._packages_channel=[];this.update()};this._removeRole=e=>{this._api_key_info.roles.splice(e,1);this.update()};const e=d()().add(1,"months").format(d().HTML5_FMT.DATE);this._api_key_info={description:"",expire_at:e,roles:[]};this._username="";this._apiStatus=o.API_STATUSES.PENDING;this._user_api_key=true;this._role={channel:"",package:"",role:"member"};this._channels=[];this._packages=[];this._roles=[];this._packages_channel=[]}get info(){if(this._user_api_key){return{user:true,key:{description:this._api_key_info.description,expire_at:this._api_key_info.expire_at,roles:[]}}}else{return{user:false,key:this._api_key_info}}}onAfterAttach(e){const t=r.ServerConnection.makeSettings();const a=i.URLExt.join(t.baseUrl,"/api/me");r.ServerConnection.makeRequest(a,{},t).then((e=>e.json())).then((async e=>{if(e.detail){return console.error(e.detail)}this._username=e.user.username;const a=i.URLExt.join(t.baseUrl,`/api/users/${this._username}/channels`);const n=await r.ServerConnection.makeRequest(a,{},t);const s=await n.json();if(s.detail){console.error(s.detail);this._channels=[]}else{this._channels=s}const l=i.URLExt.join(t.baseUrl,`/api/users/${this._username}/packages`);const c=await r.ServerConnection.makeRequest(l,{},t);const m=await c.json();if(m.detail){console.error(m.detail);this._packages=[]}else{this._packages=m}this._apiStatus=o.API_STATUSES.SUCCESS;this.update()}))}render(){const e=()=>m.createElement("div",{className:"qs-Form-Section"},m.createElement("label",{className:"qs-Input-Label"},"Channel:"),m.createElement("input",{name:"channels",type:"search",className:"jp-mod-styled",list:"channels",value:this._role.channel,onChange:this._handleChannel,placeholder:"Select a channel"}),m.createElement("datalist",{id:"channels"},this._channels.map(((e,t)=>m.createElement("option",{key:t,value:e.name},e.name)))));const t=()=>m.createElement("div",{className:"qs-Form-Section"},m.createElement("label",{className:"qs-Input-Label"},"Package"),m.createElement("input",{name:"package",type:"search",className:"jp-mod-styled",list:"packages",value:this._role.package,onChange:this._handlePackage,placeholder:"Leave blank for all packages",disabled:this._role.channel.length===0}),m.createElement("datalist",{id:"packages"},this._packages_channel.map(((e,t)=>m.createElement("option",{key:t,value:e.name},e.name)))));const a=()=>m.createElement("div",{className:"qs-Form-Section"},m.createElement("label",{className:"qs-Input-Label"},"Role"),m.createElement("select",{name:"role",className:"jp-mod-styled",value:this._role.role,onChange:this._handleRole},this._roles.map(((e,t)=>m.createElement("option",{key:t,value:e},e)))));const s=()=>m.createElement("div",{className:"qs-Form-Section"},m.createElement("table",{className:"jp-table table-small"},m.createElement("thead",null,m.createElement("tr",null,m.createElement("th",null,"Channel"),m.createElement("th",null,"Package"),m.createElement("th",null,"Role"))),m.createElement("tbody",null,this._api_key_info.roles.map(((e,t)=>m.createElement("tr",{key:t,className:"qs-clickable-Row",onClick:()=>this._removeRole(t)},m.createElement("td",null,e.channel.length!==0?e.channel:"*"),m.createElement("td",null,e.package.length!==0?e.package:"*"),m.createElement("td",null,e.role)))))));return m.createElement("form",{className:"jp-Input-Dialog"},m.createElement("div",{className:"qs-Form-Section"},m.createElement("label",{className:"qs-Form-Section-Label"},"Description"),m.createElement(n.TextField,{name:"description",value:this._api_key_info.description,onChange:this._handleDescription})),m.createElement("div",{className:"qs-Form-Section"},m.createElement("label",{className:"qs-Form-Section-Label"},"Expiration date"),m.createElement("input",{type:"date",name:"expire_at",className:"jp-mod-styled",min:d()().format(d().HTML5_FMT.DATE),value:this._api_key_info.expire_at,onChange:this._handleExpire})),m.createElement("div",{className:"qs-Form-Section-Row"},m.createElement(n.Checkbox,{id:"user-apiKey",name:"user-apiKey",checked:this._user_api_key,onChange:this._handleUserCheck},"API key with same roles as"," ",m.createElement("span",{className:"qs-Label-Caption"},this._username))),!this._user_api_key&&m.createElement(m.Fragment,null,this._apiStatus===o.API_STATUSES.PENDING&&m.createElement(o.InlineLoader,{text:"Fetching user channels and packages"}),this._channels.length!==0?m.createElement(m.Fragment,null,e(),this._role.channel.length!==0?m.createElement(m.Fragment,null,this._packages_channel.length!==0&&t(),a(),m.createElement("div",{className:"qs-Form-Section"},m.createElement(n.Button,{onClick:this._addRole,minimal:true},"Add role"))):m.createElement("label",null,"No packages available")):m.createElement("label",null,"No channels available"),this._api_key_info.roles.length!==0&&s()))}}class E extends l.ReactWidget{constructor(e){super();this._roles=e}render(){return m.createElement("table",{className:"jp-table table-small"},m.createElement("thead",null,m.createElement("tr",null,m.createElement("th",null,"Channel"),m.createElement("th",null,"Package"),m.createElement("th",null,"Role"))),m.createElement("tbody",{className:"qs-scrollable-Table"},this._roles.map(((e,t)=>m.createElement("tr",{key:t},m.createElement("td",null,e.channel?e.channel:"*"),m.createElement("td",null,e.package?e.package:"*"),m.createElement("td",null,e.role?e.role:"*"))))))}}class k extends m.PureComponent{constructor(e){super(e);this._requestApiKey=async()=>{const e=new _;const t=await(0,l.showDialog)({title:"Keys",body:e});if(t.button.accept){const t=e.info;if(!t.user&&t.key.roles.length===0){(0,l.showDialog)({title:"Format error",body:"Add roles",buttons:[l.Dialog.okButton()]});return}const a=r.ServerConnection.makeSettings();const n=i.URLExt.join(a.baseUrl,"/api/api-keys");const s={method:"POST",redirect:"follow",body:JSON.stringify(t.key),headers:{"Content-Type":"application/json"}};const o=await r.ServerConnection.makeRequest(n,s,a);const c=await o.json();if(c.detail){return console.error(c.detail)}const m=[...this.state.apiKeys,c];this.setState({apiKeys:m})}};this._showRoles=async e=>{const t=new E(e);(0,l.showDialog)({title:"Roles",body:t,buttons:[l.Dialog.okButton()]})};this._removeAPIKey=async e=>{const t=m.createElement("label",null,"Do you want to delete the API key:"," ",m.createElement("label",{className:"qs-Label-Caption"},e),".");const a=await(0,l.showDialog)({title:"Delete API key",body:t});if(a.button.accept){const t=r.ServerConnection.makeSettings();const a=i.URLExt.join(t.baseUrl,"/api/api-keys",e);const n={method:"DELETE",redirect:"follow"};const s=await r.ServerConnection.makeRequest(a,n,t);if(!s.ok){return console.error(s.statusText)}const l=this.state.apiKeys.filter((t=>t.key!==e));this.setState({apiKeys:l})}};this.state={apiKeys:[],apiStatus:o.API_STATUSES.PENDING}}async componentDidMount(){const e=r.ServerConnection.makeSettings();const t=i.URLExt.join(e.baseUrl,"/api/api-keys");const a=await r.ServerConnection.makeRequest(t,{},e);const n=await a.json();if(n.detail){return console.error(n.detail)}this.setState({apiKeys:n,apiStatus:o.API_STATUSES.SUCCESS})}render(){const{apiStatus:e,apiKeys:t}=this.state;const a=()=>t.map((e=>{if(e.roles===null){return m.createElement("tr",{key:e.key},m.createElement("td",null,e.key),m.createElement("td",null,m.createElement("label",{className:"qs-Label-Caption"},e.description)),m.createElement("td",null,e.time_created),m.createElement("td",null,e.expire_at),m.createElement("td",null,m.createElement(n.Button,{"aria-label":"Copy API key",title:"Copy API key",appearance:"stealth",minimal:true,onClick:()=>(0,o.copyToClipboard)(e.key,"API key")},m.createElement(h.FontAwesomeIcon,{icon:u.faCopy})),m.createElement(n.Button,{"aria-label":"Delete API key",title:"Delete API key",appearance:"stealth",minimal:true,onClick:()=>this._removeAPIKey(e.key)},m.createElement(h.FontAwesomeIcon,{icon:u.faTrash}))))}}));const s=()=>t.map((e=>{if(e.roles!==null){return m.createElement("tr",{key:e.key,className:"qs-clickable-Row"},m.createElement("td",{onClick:()=>this._showRoles(e.roles)},e.key),m.createElement("td",{onClick:()=>this._showRoles(e.roles)},e.description),m.createElement("td",null,e.time_created),m.createElement("td",null,e.expire_at),m.createElement("td",{onClick:()=>(0,o.copyToClipboard)(e.key,"API key")},m.createElement(h.FontAwesomeIcon,{icon:u.faCopy})),m.createElement("td",{onClick:()=>this._removeAPIKey(e.key)},m.createElement(h.FontAwesomeIcon,{icon:u.faTrash})))}}));return m.createElement("div",null,m.createElement("div",{className:"padding-bottom"},m.createElement(n.Button,{appearance:"neutral",onClick:this._requestApiKey},"Request API key")),m.createElement("h3",{className:"heading3"},"API keys"),e===o.API_STATUSES.PENDING&&m.createElement(o.InlineLoader,{text:"Fetching APIKeys"}),t.length!==0&&m.createElement("table",{className:"jp-table table-small"},m.createElement("thead",null,m.createElement("tr",null,m.createElement("th",null,"Key"),m.createElement("th",null,"Description"),m.createElement("th",null,"Created"),m.createElement("th",null,"Expires"),m.createElement("th",null,"Actions"))),m.createElement("tbody",null,a(),s())))}}const g=k;class b extends m.PureComponent{render(){const{userData:e}=this.props;return m.createElement(m.Fragment,null,m.createElement("h3",{className:"heading3"},"Profile"),m.createElement("p",{className:"caption-inline"},"Name"),m.createElement("p",{className:"paragraph"},e.name),m.createElement("p",{className:"caption-inline"},"Username"),m.createElement("p",{className:"paragraph"},e.user.username),m.createElement("p",{className:"caption-inline"},"Avatar"),m.createElement("img",{className:"user-avatar",src:e.avatar_url,alt:""}))}}const y=b;var v=a(80268);class f extends m.PureComponent{render(){const{username:e}=this.props;const t=r.ServerConnection.makeSettings();const a=i.URLExt.join(t.baseUrl,"/api/paginated/users",e,"/packages");return m.createElement(m.Fragment,null,m.createElement("h3",{className:"heading3"},"Packages"),m.createElement(v.PaginatedTable,{url:a,columns:S(),to:e=>`/${e.name}`}))}}const C=f;const S=()=>[{Header:"Name",accessor:"name",Cell:({row:e})=>m.createElement("a",{href:`/channels/${e.original.name}`},e.original.name)},{Header:"Role",accessor:"role"}];class N extends m.PureComponent{render(){const{username:e}=this.props;const t=r.ServerConnection.makeSettings();const a=i.URLExt.join(t.baseUrl,"/api/paginated/users",e,"/channels");return m.createElement(m.Fragment,null,m.createElement("h3",{className:"heading3"},"Channels"),m.createElement(v.PaginatedTable,{url:a,columns:w(),to:e=>`/${e.name}`}))}}const P=N;const w=()=>[{Header:"Name",accessor:"name",Cell:({row:e})=>m.createElement("a",{href:`/channels/${e.original.name}`},e.original.name)},{Header:"Role",accessor:"role"}];var I;(function(e){e.open="@quetz-frontend/user-extension:open";e.gotoUser="@quetz-frontend/user-extension:navigate-to-user"})(I||(I={}));const T={id:"@quetz-frontend/user-extension:plugin",autoStart:true,requires:[s.IRouter,c.IMenu],activate:(e,t,a)=>{const{shell:n,commands:s}=e;const c=r.ServerConnection.makeSettings();const h=i.URLExt.join(c.baseUrl,"/api/me");s.addCommand(I.open,{label:"Open User Panel",execute:()=>{const e=l.ReactWidget.create(m.createElement(o.FetchHoc,{url:h,loadingMessage:"Fetching user information",genericErrorMessage:"Error fetching user information"},(e=>m.createElement(R,{router:t,userData:e}))));e.id=l.DOMUtils.createDomID();e.title.label="User main page";n.add(e,"main")}});s.addCommand(I.gotoUser,{label:"Profile",isVisible:()=>a.profile!==null,execute:()=>{t.navigate("/user")}});t.register({pattern:/^\/user.*/,command:I.open});a.addItem({command:I.gotoUser,rank:501})}};const A=T;var x;(function(e){e["Profile"]="profile";e["Channels"]="channels";e["Packages"]="packages";e["ApiKeys"]="api-keys"})(x||(x={}));class R extends m.PureComponent{constructor(e){super(e);this.setTabId=e=>{this.setState({selectedTabId:e});const t=window.location.pathname.split("/");if(!Object.values(x).includes(t[t.length-1])){t.push(e)}else{t[t.length-1]=e}history.pushState(null,"",t.join("/"))};const t=window.location.pathname.split("/");const a=t.length>0?t[t.length-1]:x.Profile;this.state={selectedTabId:a!==null&&a!==void 0?a:x.Profile}}render(){const{selectedTabId:e}=this.state;const{userData:t}=this.props;const a=[{text:"Home",onClick:()=>{this.props.router.navigate("/")}},{text:"User details",onClick:()=>{this.props.router.navigate("/user")}},{text:e}];return m.createElement("div",{className:"page-contents-width-limit"},m.createElement(o.Breadcrumbs,{items:a}),m.createElement("h2",{className:"heading2"},"User Details"),m.createElement(n.Tabs,{orientation:"vertical",activeid:`user-${e}`,onChange:e=>{this.setTabId(e.target.activeid.slice(5))}},m.createElement(n.Tab,{id:"user-profile"},"Profile"),m.createElement(n.Tab,{id:"user-api-keys"},"API keys"),m.createElement(n.Tab,{id:"user-channels"},"Channels"),m.createElement(n.Tab,{id:"user-packages"},"Packages"),m.createElement(n.TabPanel,null,m.createElement(y,{userData:t})),m.createElement(n.TabPanel,null,m.createElement(g,null)),m.createElement(n.TabPanel,null,m.createElement(P,{username:t.user.username})),m.createElement(n.TabPanel,null,m.createElement(C,{username:t.user.username}))))}}}}]);