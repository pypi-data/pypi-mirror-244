{"version":3,"file":"widget.js","mappings":"yBAAA,4HCMA,MAJA,SAAkBA,GAChB,MAAuB,iBAATA,GAAqB,EAAMC,KAAKD,EAChD,ECHA,OACEE,WAFmC,oBAAXC,QAA0BA,OAAOD,YAAcC,OAAOD,WAAWE,KAAKD,SCGhG,IAAIE,EACJ,MAAMC,EAAQ,IAAIC,WAAW,IACd,SAASC,IAEtB,IAAKH,IAEHA,EAAoC,oBAAXF,QAA0BA,OAAOE,iBAAmBF,OAAOE,gBAAgBD,KAAKD,SAEpGE,GACH,MAAM,IAAII,MAAM,4GAIpB,OAAOJ,EAAgBC,EACzB,CCXA,MAAMI,EAAY,GAElB,IAAK,IAAIC,EAAI,EAAGA,EAAI,MAAOA,EACzBD,EAAUE,MAAMD,EAAI,KAAOE,SAAS,IAAIC,MAAM,IAGzC,SAASC,EAAgBC,EAAKC,EAAS,GAG5C,OAAOP,EAAUM,EAAIC,EAAS,IAAMP,EAAUM,EAAIC,EAAS,IAAMP,EAAUM,EAAIC,EAAS,IAAMP,EAAUM,EAAIC,EAAS,IAAM,IAAMP,EAAUM,EAAIC,EAAS,IAAMP,EAAUM,EAAIC,EAAS,IAAM,IAAMP,EAAUM,EAAIC,EAAS,IAAMP,EAAUM,EAAIC,EAAS,IAAM,IAAMP,EAAUM,EAAIC,EAAS,IAAMP,EAAUM,EAAIC,EAAS,IAAM,IAAMP,EAAUM,EAAIC,EAAS,KAAOP,EAAUM,EAAIC,EAAS,KAAOP,EAAUM,EAAIC,EAAS,KAAOP,EAAUM,EAAIC,EAAS,KAAOP,EAAUM,EAAIC,EAAS,KAAOP,EAAUM,EAAIC,EAAS,IAChf,CCYA,MAxBA,SAAYC,EAASC,EAAKF,GACxB,GAAI,EAAOf,aAAeiB,IAAQD,EAChC,OAAO,EAAOhB,aAIhB,MAAMkB,GADNF,EAAUA,GAAW,CAAC,GACDG,SAAWH,EAAQV,KAAOA,KAK/C,GAHAY,EAAK,GAAe,GAAVA,EAAK,GAAY,GAC3BA,EAAK,GAAe,GAAVA,EAAK,GAAY,IAEvBD,EAAK,CACPF,EAASA,GAAU,EAEnB,IAAK,IAAIN,EAAI,EAAGA,EAAI,KAAMA,EACxBQ,EAAIF,EAASN,GAAKS,EAAKT,GAGzB,OAAOQ,CACT,CAEA,OAAOJ,EAAgBK,EACzB,ECnBA,MAAME,EAAaC,OAAOC,WAAWF,WAC/BG,EAASF,OAAOC,WAAWC,OAEjC,MAAMC,EACFC,cAAgB,CACZC,QAAS,UACTC,MAAO,SAGXF,WAAa,CACTG,MAAO,eACPC,QAAS,wBACTC,OAAQ,uBACRC,MAAO,sBACPC,QAAS,wBACTC,gBAAiB,iCACjBC,iBAAkB,kCAClBC,kBAAmB,2BACnBC,kBAAmB,2BACnBC,mBAAoB,+BAGxBC,WAAAA,CAAYC,GACRC,KAAKZ,MAAQW,EACbC,KAAKX,QAAUW,KAAKZ,MAAMa,cAAe,IAAGD,KAAKE,IAAIb,WACrDW,KAAKV,OAASU,KAAKZ,MAAMa,cAAe,IAAGD,KAAKE,IAAIZ,UACpDU,KAAKR,QAAUQ,KAAKZ,MAAMa,cAAe,IAAGD,KAAKE,IAAIV,WAErDQ,KAAKG,UAAYH,KAAKI,gBACtBJ,KAAKK,gBACLL,KAAKM,kBAELN,KAAKO,cAAcC,QAAQC,IAAI,CAACT,KAAKU,eAAgBV,KAAKW,kBAC9D,CAEA,UAAIC,GACA,OAAOZ,KAAKF,YAAYc,MAC5B,CAEA,OAAIV,GACA,OAAOF,KAAKF,YAAYI,GAC5B,CAKA,SAAIW,GACA,IAAIC,EACJ,IACIA,EAAOC,KAAKC,MAAMhB,KAAKX,QAAQwB,MACnC,CAAE,MACEC,EAAO,EACX,CACA,OAAOA,CACX,CAKA,SAAID,CAAMC,GACc,iBAATA,IACPA,EAAOC,KAAKE,UAAUH,IAE1Bd,KAAKX,QAAQwB,MAAQC,CACzB,CAKA,UAAII,GACA,OAAOC,OAAOC,OAAOpB,KAAKY,QAAQS,MAAKR,GAC5Bb,KAAKZ,MAAMkC,UAAUC,SAAU,GAAEvB,KAAKE,IAAId,UAAUyB,MAEnE,CAKA,UAAIK,CAAOA,GACPC,OAAOC,OAAOpB,KAAKY,QAAQY,SAAQX,IAC/Bb,KAAKZ,MAAMkC,UAAUG,OAAQ,GAAEzB,KAAKE,IAAId,UAAUyB,IAASK,IAAWL,EAAM,GAEpF,CAKA,iBAAIa,GACA,OAAOX,KAAKC,MAAMhB,KAAKX,QAAQsC,QAAQD,cAC3C,CAKAE,SAAAA,GACI,OAAOC,MAAMC,KAAK9B,KAAKV,OAAOyC,iBAAkB,IAAG/B,KAAKE,IAAIX,SAChE,CAMAyC,cAAAA,CAAe1E,GACX,OAAO0C,KAAKiC,UAAU3E,EAC1B,CAEA4E,OAAAA,GACQlC,KAAKG,WACLH,KAAKG,UAAU+B,SAIvB,CAOA5B,eAAAA,GACI,IAAI6B,GAAe,EACnB,MAAMC,EAAS,CAAC,EAEVC,EAAiBrC,KAAKa,MAAMyB,KAAIC,IAClC,IAAIjF,EAAOiF,EAAa,KACxB,MAAoB,iBAATjF,GAAqBkF,EAAclF,IAGrCiF,EAAOE,eAAe,aACvBF,EAAOG,SAAU,GAGbN,EAAO9E,GAAQiF,IAEvBJ,GAAe,EACf7E,EAAOqF,IACCP,EAAO9E,GAAQ,CAAEA,KAAMA,GACnC,IAGJ0C,KAAKiC,UAAYG,EACbC,IACArC,KAAKa,MAAQwB,EAErB,CAMAjC,aAAAA,GACI,OAAOwC,SAASC,OAAO7C,KAAKV,OAAQ,CAChCwD,UAAW,EACXC,UAAY,IAAG/C,KAAKE,IAAIX,QACxByD,OAAQA,CAACC,EAAOC,IACRlD,KAAKkB,SAAWlB,KAAKY,OAAO1B,WAI3BgE,QAAL,GAIJC,OAAS,IAAGnD,KAAKE,IAAIT,kBACrB2D,WAAY,iBACZC,MAAOA,KACHrD,KAAKsD,MAAM,GAGvB,CAEAjD,aAAAA,GACIL,KAAKZ,MAAMmE,iBAAiB,UAAUN,IAClC,MAAMvD,EAAmBuD,EAAMC,OAAOM,QAAS,IAAGxD,KAAKE,IAAIR,oBAC3D,GAAIA,EAAkB,CAClBA,EAAiB+D,UAAW,EAC5B,MAAMC,EAAehE,EAAiB8D,QAAS,IAAGxD,KAAKE,IAAIX,SACrDjC,EAAOoG,EAAa/B,QAAQrE,KAC5BiC,EAAQS,KAAKgC,eAAe1E,GAC5BqG,EAAQjE,EAAiBO,cAAc,SACvC2D,EAAQC,QAAQF,GAASA,EAAMG,SACrCvE,EAAMmD,QAAUkB,EAChBF,EAAapC,UAAUG,OAAO,wBAAyBmC,GACvD5D,KAAKsD,MACT,KAGJtD,KAAKZ,MAAMmE,iBAAiB,SAASN,IACjC,MAAMc,EAAed,EAAMC,OAAOM,QAAS,IAAGxD,KAAKE,IAAIN,qBACnDmE,IACAd,EAAMe,iBACND,EAAaN,UAAW,EAExB1E,EAAOkF,YAAY,CACfC,WAAY,4BACZC,MAAOC,QAAQ,oBACfC,KAAMD,QAAQ,0EACd5E,QAAS,CACL,CACI8E,MAAOF,QAAQ,UACfG,YAAa,YACbC,QAASA,CAACvB,EAAOwB,KACbA,EAAMvC,SAAS,GAGvB,CACIwC,WAAW,EACXJ,MAAOF,QAAQ,UACfG,YAAa,aACbC,QAASA,CAACvB,EAAOwB,KACbA,EAAMvC,UAEQ6B,EAAaP,QAAS,IAAGxD,KAAKE,IAAIX,SAC1CoF,SAEN3E,KAAKsD,OACLtD,KAAKO,cAAcP,KAAKU,eAAe,IAInDkE,OAAQ,WACJ5E,KAAK6E,MACT,EACAC,UAAW,WACPf,EAAaN,UAAW,CAC5B,KAIR,MAAMsB,EAAe9B,EAAMC,OAAOM,QAAS,IAAGxD,KAAKE,IAAIP,qBACvD,GAAIoF,EAAc,CACd9B,EAAMe,iBACN,MAAMgB,EAAcC,EAAEC,MAAM,sBAAuB,CAAEC,KAAMJ,EAAaI,OACxEF,EAAEF,GAAcK,QAAQJ,GACnBA,EAAYK,sBACbC,EAAqBP,EAE7B,CAEA,MAAMQ,EAAetC,EAAMC,OAAOM,QAAS,IAAGxD,KAAKE,IAAIL,sBACvD,GAAI0F,EAAc,CACdtC,EAAMe,iBACN,MAAMgB,EAAcC,EAAEC,MAAM,sBAAuB,CAAEC,KAAMI,EAAaJ,OACxEF,EAAEM,GAAcH,QAAQJ,GACnBA,EAAYK,sBACbC,EAAqBC,EAE7B,IAER,CAMAC,YAAAA,CAAajG,GACT,MAAMjC,EAAOiC,EAAMjC,KACnB,IAAKkF,EAAclF,GACf,MAAM,IAAIS,MAAM,gBAGpB,MAAM0H,EAAWzF,KAAKa,MACtB4E,EAASvH,KAAKqB,GACdS,KAAKa,MAAQ4E,EAEbzF,KAAKiC,UAAU3E,GAAQiC,CAC3B,CAEA+D,IAAAA,GACItD,KAAKa,MAAQb,KAAK4B,YAAYU,KAAI/C,IAC9B,MAAMjC,EAAOiC,EAAMoC,QAAQrE,KAC3B,OAAO0C,KAAKgC,eAAe1E,EAAK,GAExC,CAMAiD,aAAAA,CAAcmF,GAEV,OADA1F,KAAKkB,OAASlB,KAAKY,OAAO1B,QACnBwG,EAAQC,SAAQ,KACnB3F,KAAKkB,OAASlB,KAAKY,OAAOzB,KAAK,GAEvC,CAEAuB,YAAAA,GACI,OAAOV,KAAK4F,aAAa,CACrBlE,cAAe1B,KAAK0B,cACpBb,MAAOb,KAAKa,OAEpB,CAEA+E,YAAAA,CAAa9E,GACT,MAAM+E,EAAY7F,KAAKZ,MAAMuC,QAAQmE,gBACrC,OAAOC,MAAMF,EAAW,CACpBG,OAAQ,OACRC,KAAM,cACNC,MAAO,WACPC,QAAS,CACL,eAAgB,kCAEpB9B,KAAMtD,KAAKE,UAAUH,KAEpBsF,MAAKC,IACF,IAAKA,EAASC,GACV,KAAO,GAAED,EAASnF,UAAUmF,EAASE,aAEzC,OAAOF,EAASG,MAAM,IAEzBJ,MAAKC,IACFrG,KAAKV,OAAOmH,UAAYJ,EAAS/G,MAAM,IAE1CoH,OAAMC,IACCA,aAAkB5I,OAElB6I,QAAQC,MAAMF,GAElB5H,EAAO+H,WAAWH,EAAO,GAErC,CAEAhG,aAAAA,GACI,OAAOX,KAAK+G,cAAc,CACtBC,SAAUhH,KAAKX,QAAQ4H,GACvBvF,cAAe1B,KAAK0B,eAE5B,CAEAqF,aAAAA,CAAcjG,GACV,MAAM+E,EAAY7F,KAAKZ,MAAMuC,QAAQuF,iBACrC,OAAOnB,MAAMF,EAAW,CACpBG,OAAQ,OACRC,KAAM,cACNC,MAAO,WACPC,QAAS,CACL,eAAgB,kCAEpB9B,KAAMtD,KAAKE,UAAUH,KAEpBsF,MAAKC,IACF,IAAKA,EAASC,GACV,KAAO,GAAED,EAASnF,UAAUmF,EAASE,aAEzC,OAAOF,EAASG,MAAM,IAEzBJ,MAAKC,IACFrG,KAAKR,QAAQiH,UAAYJ,EAAS7G,OAAO,GAErD,EAkBJ,SAAS8F,EAAqB6B,GAC1B,OAAOvI,EAAWwI,eAAeD,EAAgB,MAAM,EAC3D,CAqFA,IAAuCE,EAtGvCC,OAAOC,SAAS,oBAAqB,CACjCC,KAAM,SAAUzH,GACZA,EAAQ0H,aAAe,IAAIzI,EAAYe,EAASC,KACpD,EACAkC,QAAS,SAAUnC,GACXA,EAAQ0H,eACR1H,EAAQ0H,aAAavF,iBACdnC,EAAQ0H,aAEvB,IA8HJ5I,OAAO6I,2BAjCgCL,EAiC0BxI,OAAO6I,0BAhC7D,SAASC,EAAKC,GACjB,MAAMC,EAAOjJ,EAAWkJ,iBAAiBH,EAAIE,MACvCE,EAAQ,+DAA+DC,KAAKH,GAClF,GAAIE,EAAO,CACP,MAAM1I,EAAU4I,SAASC,eAAeH,EAAMI,OAAOC,WAChD/I,IACDuH,QAAQC,MAAO,uBAAsBkB,EAAMI,OAAOC,aAClDxJ,EAAWyJ,oBAAoBV,GAC/BA,EAAIW,SAGR,MAAMlJ,EAAQC,EAAQmE,QAAQ,iBACxB+E,EAAcnJ,GAASA,EAAMqI,aAEnCc,EAAY/C,aAAa,CACrBgD,MAAOT,EAAMI,OAAOM,WACpBC,GAAId,EACJtK,KAAMqF,IACND,SAAS,IAGb6F,EAAYhI,cAAcgI,EAAY7H,gBAEtC9B,EAAWyJ,oBAAoBV,GAC/BA,EAAIW,OACR,MACIjB,EAAasB,MAAM9J,OAAQ+J,UAEnC,GAKJ/J,OAAOgK,6BAlHP,SAAoCxB,GAChC,OAAO,SAASM,EAAKmB,EAAOC,GACxB,MAAMlB,EAAOjJ,EAAWkJ,iBAAiBH,EAAIE,MACvCE,EAAQ,4DAA4DC,KAAKH,GAC/E,GAAIE,EAAO,CACP,MAAM1I,EAAU4I,SAASC,eAAeH,EAAMI,OAAOC,WAChD/I,IACDuH,QAAQC,MAAO,uBAAsBkB,EAAMI,OAAOC,aAClDxJ,EAAWyJ,oBAAoBV,GAC/BA,EAAIW,SAGR,MAAMlJ,EAAQC,EAAQmE,QAAQ,iBACxB+E,EAAcnJ,GAASA,EAAMqI,aAEnCc,EAAY/C,aAAa,CACrBgD,MAAOT,EAAMI,OAAOM,WACpBC,GAAII,EACJxL,KAAMqF,IACND,SAAS,IAGb6F,EAAYhI,cAAcgI,EAAY7H,gBAEtC9B,EAAWyJ,oBAAoBV,GAC/BA,EAAIW,OACR,MACIjB,EAAasB,MAAM9J,OAAQ+J,UAEnC,CACJ,CAoFsCI,CAA2BnK,OAAOgK,8BACxEhK,OAAOoK,gCAhFP,SAAuC5B,GACnC,OAAO,SAASM,EAAKuB,EAAOH,EAASD,GACjC,MAAMjB,EAAOjJ,EAAWkJ,iBAAiBH,EAAIE,MACvCE,EAAQ,yCAAyCC,KAAKH,GAC5D,GAAIE,EAAO,CACP,MAAMxI,EAAQ0I,SAAShI,cAAe,mCAAkC8H,EAAMI,OAAO7K,UAChFiC,IACDqH,QAAQC,MAAO,oBAAmBkB,EAAMI,OAAO7K,QAC/CsB,EAAWyJ,oBAAoBV,GAC/BA,EAAIW,SAGR,MAAMa,EAAe5J,GAASA,EAAMiE,QAAQ,iBACtCpE,EAAQ+J,GAAgBA,EAAaC,mBAC1BhK,GAASA,EAAMqI,cAEvB/G,eAET9B,EAAWyJ,oBAAoBV,GAC/BA,EAAIW,OACR,MACIjB,EAAasB,MAAM9J,OAAQ+J,UAEnC,CACJ,CAwDyCS,CAA8BxK,OAAOoK,iCAC9EpK,OAAOyK,gCApDP,SAAuCjC,GACnC,OAAO,SAASM,EAAKuB,GACjB,MAAMrB,EAAOjJ,EAAWkJ,iBAAiBH,EAAIE,MAC/B,+DAA+DG,KAAKH,GAE9EF,EAAI4B,QAAQC,GAAyB,EAArB7B,EAAI4B,QAAQE,QAE5BpC,EAAasB,MAAM9J,OAAQ+J,UAEnC,CACJ,CA0CyCc,CAA8B7K,OAAOyK,gC","sources":["webpack://paper-streamfield/./node_modules/uuid/dist/esm-browser/regex.js","webpack://paper-streamfield/./node_modules/uuid/dist/esm-browser/validate.js","webpack://paper-streamfield/./node_modules/uuid/dist/esm-browser/native.js","webpack://paper-streamfield/./node_modules/uuid/dist/esm-browser/rng.js","webpack://paper-streamfield/./node_modules/uuid/dist/esm-browser/stringify.js","webpack://paper-streamfield/./node_modules/uuid/dist/esm-browser/v4.js","webpack://paper-streamfield/./streamfield/static/streamfield/src/widget.js"],"sourcesContent":["export default /^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;","import REGEX from './regex.js';\n\nfunction validate(uuid) {\n  return typeof uuid === 'string' && REGEX.test(uuid);\n}\n\nexport default validate;","const randomUUID = typeof crypto !== 'undefined' && crypto.randomUUID && crypto.randomUUID.bind(crypto);\nexport default {\n  randomUUID\n};","// Unique ID creation requires a high quality random # generator. In the browser we therefore\n// require the crypto API and do not support built-in fallback to lower quality random number\n// generators (like Math.random()).\nlet getRandomValues;\nconst rnds8 = new Uint8Array(16);\nexport default function rng() {\n  // lazy load so that environments that need to polyfill have a chance to do so\n  if (!getRandomValues) {\n    // getRandomValues needs to be invoked in a context where \"this\" is a Crypto implementation.\n    getRandomValues = typeof crypto !== 'undefined' && crypto.getRandomValues && crypto.getRandomValues.bind(crypto);\n\n    if (!getRandomValues) {\n      throw new Error('crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported');\n    }\n  }\n\n  return getRandomValues(rnds8);\n}","import validate from './validate.js';\n/**\n * Convert array of 16 byte values to UUID string format of the form:\n * XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX\n */\n\nconst byteToHex = [];\n\nfor (let i = 0; i < 256; ++i) {\n  byteToHex.push((i + 0x100).toString(16).slice(1));\n}\n\nexport function unsafeStringify(arr, offset = 0) {\n  // Note: Be careful editing this code!  It's been tuned for performance\n  // and works in ways you may not expect. See https://github.com/uuidjs/uuid/pull/434\n  return byteToHex[arr[offset + 0]] + byteToHex[arr[offset + 1]] + byteToHex[arr[offset + 2]] + byteToHex[arr[offset + 3]] + '-' + byteToHex[arr[offset + 4]] + byteToHex[arr[offset + 5]] + '-' + byteToHex[arr[offset + 6]] + byteToHex[arr[offset + 7]] + '-' + byteToHex[arr[offset + 8]] + byteToHex[arr[offset + 9]] + '-' + byteToHex[arr[offset + 10]] + byteToHex[arr[offset + 11]] + byteToHex[arr[offset + 12]] + byteToHex[arr[offset + 13]] + byteToHex[arr[offset + 14]] + byteToHex[arr[offset + 15]];\n}\n\nfunction stringify(arr, offset = 0) {\n  const uuid = unsafeStringify(arr, offset); // Consistency check for valid UUID.  If this throws, it's likely due to one\n  // of the following:\n  // - One or more input array values don't map to a hex octet (leading to\n  // \"undefined\" in the uuid)\n  // - Invalid input values for the RFC `version` or `variant` fields\n\n  if (!validate(uuid)) {\n    throw TypeError('Stringified UUID is invalid');\n  }\n\n  return uuid;\n}\n\nexport default stringify;","import native from './native.js';\nimport rng from './rng.js';\nimport { unsafeStringify } from './stringify.js';\n\nfunction v4(options, buf, offset) {\n  if (native.randomUUID && !buf && !options) {\n    return native.randomUUID();\n  }\n\n  options = options || {};\n  const rnds = options.random || (options.rng || rng)(); // Per 4.4, set bits for version and `clock_seq_hi_and_reserved`\n\n  rnds[6] = rnds[6] & 0x0f | 0x40;\n  rnds[8] = rnds[8] & 0x3f | 0x80; // Copy bytes to buffer, if provided\n\n  if (buf) {\n    offset = offset || 0;\n\n    for (let i = 0; i < 16; ++i) {\n      buf[offset + i] = rnds[i];\n    }\n\n    return buf;\n  }\n\n  return unsafeStringify(rnds);\n}\n\nexport default v4;","/* global gettext */\n/* global Sortable */\n/* global XClass */\nimport { v4 as uuid4, validate as uuid_validate } from \"uuid\";\n\nimport \"./widget.scss\";\n\nconst popupUtils = window.paperAdmin.popupUtils;\nconst modals = window.paperAdmin.modals;\n\nclass StreamField {\n    static STATUS = {\n        LOADING: \"loading\",\n        READY: \"ready\"\n    };\n\n    static CSS = {\n        field: \"stream-field\",\n        control: \"stream-field__control\",\n        blocks: \"stream-field__blocks\",\n        block: \"stream-field__block\",\n        buttons: \"stream-field__buttons\",\n        sortableHandler: \"stream-field__sortable-handler\",\n        visibilitySwitch: \"stream-field__visibility-switch\",\n        changeBlockButton: \"stream-field__change-btn\",\n        deleteBlockButton: \"stream-field__delete-btn\",\n        dropdownItemButton: \"stream-field__dropdown-item\" // create or lookup block\n    };\n\n    constructor(element) {\n        this.field = element;\n        this.control = this.field.querySelector(`.${this.CSS.control}`);\n        this.blocks = this.field.querySelector(`.${this.CSS.blocks}`);\n        this.buttons = this.field.querySelector(`.${this.CSS.buttons}`);\n\n        this._sortable = this._initSortable();\n        this._addListeners();\n        this._updateBlockMap();\n\n        this.wrapPreloader(Promise.all([this.updateBlocks(), this.updateButtons()]));\n    }\n\n    get STATUS() {\n        return this.constructor.STATUS;\n    }\n\n    get CSS() {\n        return this.constructor.CSS;\n    }\n\n    /**\n     * @returns {Array}\n     */\n    get value() {\n        let data;\n        try {\n            data = JSON.parse(this.control.value);\n        } catch {\n            data = [];\n        }\n        return data;\n    }\n\n    /**\n     * @param {string|Array} data\n     */\n    set value(data) {\n        if (typeof data !== \"string\") {\n            data = JSON.stringify(data);\n        }\n        this.control.value = data;\n    }\n\n    /**\n     * @returns {string}\n     */\n    get status() {\n        return Object.values(this.STATUS).find(value => {\n            return this.field.classList.contains(`${this.CSS.field}--${value}`);\n        });\n    }\n\n    /**\n     * @param {string} status\n     */\n    set status(status) {\n        Object.values(this.STATUS).forEach(value => {\n            this.field.classList.toggle(`${this.CSS.field}--${value}`, status === value);\n        });\n    }\n\n    /**\n     * @returns {String[]}\n     */\n    get allowedModels() {\n        return JSON.parse(this.control.dataset.allowedModels);\n    }\n\n    /**\n     * @returns {HTMLElement[]}\n     */\n    getBlocks() {\n        return Array.from(this.blocks.querySelectorAll(`.${this.CSS.block}`));\n    }\n\n    /**\n     * @param {string} uuid\n     * @returns {Object}\n     */\n    getBlockByUUID(uuid) {\n        return this._blockMap[uuid];\n    }\n\n    destroy() {\n        if (this._sortable) {\n            this._sortable.destroy();\n        }\n\n        // TODO: remove event listeners\n    }\n\n    /**\n     * Создаёт объект для быстрого поиска блоков по UUID.\n     *\n     * @returns {Object}\n     */\n    _updateBlockMap() {\n        let hasBadBlocks = false;\n        const result = {};\n\n        const processedValue = this.value.map(record => {\n            let uuid = record[\"uuid\"];\n            if (typeof uuid === \"string\" && uuid_validate(uuid)) {\n                // Add visibility field for data created\n                // with `paper-streamfield` <= 0.6.0\n                if (!record.hasOwnProperty(\"visible\")) {\n                    record.visible = true;\n                }\n\n                return (result[uuid] = record);\n            } else {\n                hasBadBlocks = true;\n                uuid = uuid4();\n                return (result[uuid] = { uuid: uuid });\n            }\n        });\n\n        this._blockMap = result;\n        if (processedValue) {\n            this.value = processedValue;\n        }\n    }\n\n    /**\n     * @returns {*}\n     * @private\n     */\n    _initSortable() {\n        return Sortable.create(this.blocks, {\n            animation: 0,\n            draggable: `.${this.CSS.block}`,\n            filter: (event, target) => {\n                if (this.status === this.STATUS.LOADING) {\n                    return true;\n                }\n\n                if (!target) {\n                    return true;\n                }\n            },\n            handle: `.${this.CSS.sortableHandler}`,\n            ghostClass: \"sortable-ghost\",\n            onEnd: () => {\n                this.save();\n            }\n        });\n    }\n\n    _addListeners() {\n        this.field.addEventListener(\"change\", event => {\n            const visibilitySwitch = event.target.closest(`.${this.CSS.visibilitySwitch}`);\n            if (visibilitySwitch) {\n                visibilitySwitch.disabled = true;\n                const blockElement = visibilitySwitch.closest(`.${this.CSS.block}`);\n                const uuid = blockElement.dataset.uuid;\n                const block = this.getBlockByUUID(uuid);\n                const input = visibilitySwitch.querySelector(\"input\");\n                const state = Boolean(input && input.checked);\n                block.visible = state;\n                blockElement.classList.toggle(\"stream-field--hidden\", !state);\n                this.save();\n            }\n        });\n\n        this.field.addEventListener(\"click\", event => {\n            const deleteButton = event.target.closest(`.${this.CSS.deleteBlockButton}`);\n            if (deleteButton) {\n                event.preventDefault();\n                deleteButton.disabled = true;\n\n                modals.createModal({\n                    modalClass: \"paper-modal--warning fade\",\n                    title: gettext(\"Confirm deletion\"),\n                    body: gettext(\"Are you sure you want to <b>DELETE</b> selected block from this field?\"),\n                    buttons: [\n                        {\n                            label: gettext(\"Cancel\"),\n                            buttonClass: \"btn-light\",\n                            onClick: (event, popup) => {\n                                popup.destroy();\n                            }\n                        },\n                        {\n                            autofocus: true,\n                            label: gettext(\"Delete\"),\n                            buttonClass: \"btn-danger\",\n                            onClick: (event, popup) => {\n                                popup.destroy();\n\n                                const block = deleteButton.closest(`.${this.CSS.block}`);\n                                block.remove();\n\n                                this.save();\n                                this.wrapPreloader(this.updateBlocks());\n                            }\n                        }\n                    ],\n                    onInit: function () {\n                        this.show();\n                    },\n                    onDestroy: function () {\n                        deleteButton.disabled = false;\n                    }\n                });\n            }\n\n            const changeButton = event.target.closest(`.${this.CSS.changeBlockButton}`);\n            if (changeButton) {\n                event.preventDefault();\n                const jQueryEvent = $.Event(\"django:show-related\", { href: changeButton.href });\n                $(changeButton).trigger(jQueryEvent);\n                if (!jQueryEvent.isDefaultPrevented()) {\n                    showStreamBlockPopup(changeButton);\n                }\n            }\n\n            const dropdownItem = event.target.closest(`.${this.CSS.dropdownItemButton}`);\n            if (dropdownItem) {\n                event.preventDefault();\n                const jQueryEvent = $.Event(\"django:show-related\", { href: dropdownItem.href });\n                $(dropdownItem).trigger(jQueryEvent);\n                if (!jQueryEvent.isDefaultPrevented()) {\n                    showStreamBlockPopup(dropdownItem);\n                }\n            }\n        });\n    }\n\n    /**\n     * @param {Object} block\n     * @private\n     */\n    _appendBlock(block) {\n        const uuid = block.uuid;\n        if (!uuid_validate(uuid)) {\n            throw new Error(\"Invalid UUID\");\n        }\n\n        const newValue = this.value;\n        newValue.push(block);\n        this.value = newValue;\n\n        this._blockMap[uuid] = block;\n    }\n\n    save() {\n        this.value = this.getBlocks().map(block => {\n            const uuid = block.dataset.uuid;\n            return this.getBlockByUUID(uuid);\n        });\n    }\n\n    /**\n     * @param {Promise} promise\n     * @returns {Promise}\n     */\n    wrapPreloader(promise) {\n        this.status = this.STATUS.LOADING;\n        return promise.finally(() => {\n            this.status = this.STATUS.READY;\n        });\n    }\n\n    updateBlocks() {\n        return this.renderStream({\n            allowedModels: this.allowedModels,\n            value: this.value\n        });\n    }\n\n    renderStream(data) {\n        const renderUrl = this.field.dataset.renderStreamUrl;\n        return fetch(renderUrl, {\n            method: \"POST\",\n            mode: \"same-origin\",\n            cache: \"no-store\",\n            headers: {\n                \"Content-Type\": \"application/json;charset=utf-8\"\n            },\n            body: JSON.stringify(data)\n        })\n            .then(response => {\n                if (!response.ok) {\n                    throw `${response.status} ${response.statusText}`;\n                }\n                return response.json();\n            })\n            .then(response => {\n                this.blocks.innerHTML = response.blocks;\n            })\n            .catch(reason => {\n                if (reason instanceof Error) {\n                    // JS-ошибки дублируем в консоль\n                    console.error(reason);\n                }\n                modals.showErrors(reason);\n            });\n    }\n\n    updateButtons() {\n        return this.renderButtons({\n            field_id: this.control.id,\n            allowedModels: this.allowedModels\n        });\n    }\n\n    renderButtons(data) {\n        const renderUrl = this.field.dataset.renderButtonsUrl;\n        return fetch(renderUrl, {\n            method: \"POST\",\n            mode: \"same-origin\",\n            cache: \"no-store\",\n            headers: {\n                \"Content-Type\": \"application/json;charset=utf-8\"\n            },\n            body: JSON.stringify(data)\n        })\n            .then(response => {\n                if (!response.ok) {\n                    throw `${response.status} ${response.statusText}`;\n                }\n                return response.json();\n            })\n            .then(response => {\n                this.buttons.innerHTML = response.buttons;\n            });\n    }\n}\n\nXClass.register(\"paper-streamfield\", {\n    init: function (element) {\n        element._streamField = new StreamField(element, this);\n    },\n    destroy: function (element) {\n        if (element._streamField) {\n            element._streamField.destroy();\n            delete element._streamField;\n        }\n    }\n});\n\n/**\n * @param {HTMLElement} triggeringLink\n */\nfunction showStreamBlockPopup(triggeringLink) {\n    return popupUtils.showAdminPopup(triggeringLink, /^$/, true);\n}\n\n/**\n * @param {Function} originalFunc\n */\nfunction dismissAddStreamBlockPopup(originalFunc) {\n    return function(win, newId, newRepr) {\n        const name = popupUtils.removePopupIndex(win.name);\n        const match = /^streamfield:add_(?<elementId>.+)--(?<blockModel>.+\\..+)$/.exec(name);\n        if (match) {\n            const control = document.getElementById(match.groups.elementId);\n            if (!control) {\n                console.error(`Control not found: #${match.groups.elementId}`);\n                popupUtils.removeRelatedWindow(win);\n                win.close();\n            }\n\n            const field = control.closest(\".stream-field\");\n            const streamField = field && field._streamField;\n\n            streamField._appendBlock({\n                model: match.groups.blockModel,\n                pk: newId,\n                uuid: uuid4(),\n                visible: true\n            });\n\n            streamField.wrapPreloader(streamField.updateBlocks());\n\n            popupUtils.removeRelatedWindow(win);\n            win.close();\n        } else {\n            originalFunc.apply(window, arguments);\n        }\n    }\n}\n\n/**\n * @param {Function} originalFunc\n */\nfunction dismissChangeStreamBlockPopup(originalFunc) {\n    return function(win, objId, newRepr, newId) {\n        const name = popupUtils.removePopupIndex(win.name);\n        const match = /^streamfield:change_block_(?<uuid>.+)$/.exec(name);\n        if (match) {\n            const block = document.querySelector(`.stream-field__block[data-uuid=\"${match.groups.uuid}\"]`);\n            if (!block) {\n                console.error(`Block not found: ${match.groups.uuid}`);\n                popupUtils.removeRelatedWindow(win);\n                win.close();\n            }\n\n            const fieldWrapper = block && block.closest(\".paper-widget\");\n            const field = fieldWrapper && fieldWrapper.firstElementChild;\n            const instance = field && field._streamField;\n\n            instance.updateBlocks();\n\n            popupUtils.removeRelatedWindow(win);\n            win.close();\n        } else {\n            originalFunc.apply(window, arguments);\n        }\n    }\n}\n\n/**\n * @param {Function} originalFunc\n */\nfunction dismissDeleteStreamBlockPopup(originalFunc) {\n    return function(win, objId) {\n        const name = popupUtils.removePopupIndex(win.name);\n        const match = /^streamfield:lookup_(?<elementId>.+)--(?<blockModel>.+\\..+)$/.exec(name);\n        if (match) {\n            win.history.go(-win.history.length + 1);\n        } else {\n            originalFunc.apply(window, arguments);\n        }\n    }\n}\n\n/**\n * Обёртка над Django-обработчиком `window.dismissRelatedLookupPopup`.\n * @param {Function} originalFunc\n */\nfunction dismissLookupStreamBlockPopup(originalFunc) {\n    return function(win, chosenId) {\n        const name = popupUtils.removePopupIndex(win.name);\n        const match = /^streamfield:lookup_(?<elementId>.+)--(?<blockModel>.+\\..+)$/.exec(name);\n        if (match) {\n            const control = document.getElementById(match.groups.elementId);\n            if (!control) {\n                console.error(`Control not found: #${match.groups.elementId}`);\n                popupUtils.removeRelatedWindow(win);\n                win.close();\n            }\n\n            const field = control.closest(\".stream-field\");\n            const streamField = field && field._streamField;\n\n            streamField._appendBlock({\n                model: match.groups.blockModel,\n                pk: chosenId,\n                uuid: uuid4(),\n                visible: true\n            });\n\n            streamField.wrapPreloader(streamField.updateBlocks());\n\n            popupUtils.removeRelatedWindow(win);\n            win.close();\n        } else {\n            originalFunc.apply(window, arguments);\n        }\n    }\n}\n\n// Wrap default callbacks.\nwindow.dismissRelatedLookupPopup = dismissLookupStreamBlockPopup(window.dismissRelatedLookupPopup);\nwindow.dismissAddRelatedObjectPopup = dismissAddStreamBlockPopup(window.dismissAddRelatedObjectPopup);\nwindow.dismissChangeRelatedObjectPopup = dismissChangeStreamBlockPopup(window.dismissChangeRelatedObjectPopup);\nwindow.dismissDeleteRelatedObjectPopup = dismissDeleteStreamBlockPopup(window.dismissDeleteRelatedObjectPopup);\n"],"names":["uuid","test","randomUUID","crypto","bind","getRandomValues","rnds8","Uint8Array","rng","Error","byteToHex","i","push","toString","slice","unsafeStringify","arr","offset","options","buf","rnds","random","popupUtils","window","paperAdmin","modals","StreamField","static","LOADING","READY","field","control","blocks","block","buttons","sortableHandler","visibilitySwitch","changeBlockButton","deleteBlockButton","dropdownItemButton","constructor","element","this","querySelector","CSS","_sortable","_initSortable","_addListeners","_updateBlockMap","wrapPreloader","Promise","all","updateBlocks","updateButtons","STATUS","value","data","JSON","parse","stringify","status","Object","values","find","classList","contains","forEach","toggle","allowedModels","dataset","getBlocks","Array","from","querySelectorAll","getBlockByUUID","_blockMap","destroy","hasBadBlocks","result","processedValue","map","record","uuid_validate","hasOwnProperty","visible","uuid4","Sortable","create","animation","draggable","filter","event","target","handle","ghostClass","onEnd","save","addEventListener","closest","disabled","blockElement","input","state","Boolean","checked","deleteButton","preventDefault","createModal","modalClass","title","gettext","body","label","buttonClass","onClick","popup","autofocus","remove","onInit","show","onDestroy","changeButton","jQueryEvent","$","Event","href","trigger","isDefaultPrevented","showStreamBlockPopup","dropdownItem","_appendBlock","newValue","promise","finally","renderStream","renderUrl","renderStreamUrl","fetch","method","mode","cache","headers","then","response","ok","statusText","json","innerHTML","catch","reason","console","error","showErrors","renderButtons","field_id","id","renderButtonsUrl","triggeringLink","showAdminPopup","originalFunc","XClass","register","init","_streamField","dismissRelatedLookupPopup","win","chosenId","name","removePopupIndex","match","exec","document","getElementById","groups","elementId","removeRelatedWindow","close","streamField","model","blockModel","pk","apply","arguments","dismissAddRelatedObjectPopup","newId","newRepr","dismissAddStreamBlockPopup","dismissChangeRelatedObjectPopup","objId","fieldWrapper","firstElementChild","dismissChangeStreamBlockPopup","dismissDeleteRelatedObjectPopup","history","go","length","dismissDeleteStreamBlockPopup"],"sourceRoot":""}